on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"

jobs:
  send:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install requests
        run: pip install requests

      - name: Run RSS Script
        env:
          BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          CHAT_ID: "@netralnews_2026"
        run: |
          python3 - << 'EOF'
          import os
          import requests
          import re

          BOT_TOKEN = os.environ["BOT_TOKEN"]
          CHAT_ID = os.environ["CHAT_ID"]

          rss_url = "https://www.antaranews.com/rss/terkini.xml"
          response = requests.get(rss_url, timeout=10)

          if response.status_code != 200:
              print("RSS gagal diakses")
              exit()

          content = response.text
          items = re.findall(r"<item>(.*?)</item>", content, re.DOTALL)

          if not items:
              print("Tidak ada item RSS")
              exit()

          # Baca last link
          last_link = None
          if os.path.exists("last.txt"):
              with open("last.txt", "r") as f:
                  last_link = f.read().strip()

          new_links = []
          messages = []

          for item in items:
              title_match = re.search(r"<title>(.*?)</title>", item)
              link_match = re.search(r"<link>(.*?)</link>", item)

              if not title_match or not link_match:
                  continue

              title = title_match.group(1)
              link = link_match.group(1)

              if link == last_link:
                  break

              messages.append(f"{title}\n\n{link}")
              new_links.append(link)

          if not messages:
              print("Tidak ada berita baru")
              exit()

          # Kirim dari yang paling lama dulu
          messages.reverse()

          for msg in messages:
              send_url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
              r = requests.post(send_url, data={
                  "chat_id": CHAT_ID,
                  "text": msg
              })
              print(r.status_code, r.text)

          # Simpan link terbaru
          with open("last.txt", "w") as f:
              f.write(new_links[0])

          EOF

      - name: Commit last.txt
        run: |
          git config user.name "rss-bot"
          git config user.email "bot@github.com"
          git add last.txt
          git commit -m "Update last RSS link" || echo "No changes"
          git push
