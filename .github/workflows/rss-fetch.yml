name: RSS Auto Post

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"

jobs:
  send:
    runs-on: ubuntu-latest

    steps:
      - name: Install requests
        run: pip install requests

      - name: Send Latest RSS
        env:
          BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          CHAT_ID: "@netralnews_2026"
        run: |
          python3 - << 'EOF'
          import os
          import requests
          import re

          # Ambil token & chat_id dari environment
          BOT_TOKEN = os.environ["BOT_TOKEN"]
          CHAT_ID = os.environ["CHAT_ID"]

          # Ambil RSS
          rss_url = "https://www.antaranews.com/rss/terkini.xml"
          response = requests.get(rss_url, timeout=10)

          if response.status_code != 200:
              print("RSS gagal diakses")
              exit()

          content = response.text

          # Ambil item pertama
          items = re.findall(r"<item>(.*?)</item>", content, re.DOTALL)
          if not items:
              print("Tidak ada item RSS")
              exit()

          first = items[0]

          title_match = re.search(r"<title>(.*?)</title>", first)
          link_match = re.search(r"<link>(.*?)</link>", first)

          if not title_match or not link_match:
              print("Gagal parsing RSS")
              exit()

          title = title_match.group(1)
          link = link_match.group(1)

          message = f"{title}\n\n{link}"

          # Kirim ke Telegram
          send_url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"

          r = requests.post(send_url, data={
              "chat_id": CHAT_ID,
              "text": message
          })

          print("Status:", r.status_code)
          print("Response:", r.text)
          EOF
