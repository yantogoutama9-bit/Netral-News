name: RSS to Telegram - Netral News

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  fetch-and-send:
    runs-on: ubuntu-latest

    env:
      TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
      CHAT_ID: "@netralnews_2026"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install requests feedparser

      - name: Fetch RSS & send to Telegram
        run: |
          python << 'EOF'
import requests
import feedparser

BOT_TOKEN = "${TG_BOT_TOKEN}"
CHAT_ID = "${CHAT_ID}"

# =========================
# TEST PAKSA (HARUS MASUK)
# =========================
resp = requests.post(
    f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage",
    data={
        "chat_id": CHAT_ID,
        "text": "âœ… TEST BOT NETRAL NEWS â€” JIKA INI MUNCUL, BOT & CHANNEL AMAN"
    }
)

print("TEST STATUS:", resp.status_code)
print(resp.text)

# =========================
# RSS FEEDS
# =========================
RSS_FEEDS = [
    "https://rss.kompas.com/",
    "https://www.cnnindonesia.com/rss",
    "https://kbr.id/rss",
    "https://www.bola.com/rss"
]

sent = 0

for url in RSS_FEEDS:
    feed = feedparser.parse(url)
    for entry in feed.entries[:1]:
        title = entry.title
        link = entry.link
        summary = entry.get("summary") or entry.get("description") or ""
        summary = summary[:200]

        message = f"ðŸ“° {title}\n\n{summary}\n\nðŸ”— {link}"

        r = requests.post(
            f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage",
            data={
                "chat_id": CHAT_ID,
                "text": message
            }
        )

        if r.status_code == 200:
            sent += 1

print("TOTAL TERKIRIM:", sent)
EOF
