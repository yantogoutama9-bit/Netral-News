name: RSS Auto Post (Latest News with pubDate)

on:
  schedule:
    - cron: "*/15 * * * *"  # UTC
  workflow_dispatch:

jobs:
  send:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install dependencies
        run: pip install requests beautifulsoup4

      - name: Run RSS Script
        env:
          BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          CHAT_ID: "@netralnews_2026"
        run: |
          python3 - << 'EOF'
          import os
          import requests
          from bs4 import BeautifulSoup
          from datetime import datetime
          import email.utils as eut

          BOT_TOKEN = os.environ["BOT_TOKEN"]
          CHAT_ID = os.environ["CHAT_ID"]

          print("=== RSS Job Started UTC:", datetime.utcnow(), "===")

          RSS_SOURCES = {
              "KOMPAS": "https://rss.kompas.com/rss",
              "BISNIS": "https://www.bisnis.com/rss/all/news",
              "CNN INDONESIA": "https://www.cnnindonesia.com/rss",
              "GOAL (BOLA)": "https://www.goal.com/feeds/en/news"
          }

          # Load history: key = guid/link + pubDate
          sent_keys = set()
          if os.path.exists("last.txt"):
              with open("last.txt","r") as f:
                  sent_keys = set(line.strip() for line in f.readlines() if line.strip())

          new_keys = []
          messages = []

          for source, url in RSS_SOURCES.items():
              try:
                  r = requests.get(url, timeout=12)
                  if r.status_code != 200:
                      print(f"[WARN] RSS {source} gagal ({r.status_code})")
                      continue
                  soup = BeautifulSoup(r.content, "xml")
                  items = soup.find_all("item")
              except Exception as e:
                  print(f"[ERROR] RSS {source} exception: {e}")
                  continue

              if not items:
                  print(f"[INFO] RSS {source} tidak ada item")
                  continue

              for item in items[:10]:  # ambil max 10 berita terbaru per feed
                  title_tag = item.find("title")
                  link_tag = item.find("link")
                  guid_tag = item.find("guid")
                  pubdate_tag = item.find("pubDate")

                  title = title_tag.text.strip() if title_tag else None
                  link = link_tag.text.strip() if link_tag else None
                  guid = guid_tag.text.strip() if guid_tag else None
                  pubdate = pubdate_tag.text.strip() if pubdate_tag else None

                  if not title or not (link or guid):
                      continue

                  # key unik = guid/link + timestamp
                  timestamp = pubdate if pubdate else ""
                  key = f"{guid if guid else link}__{timestamp}"

                  if key in sent_keys:
                      continue

                  msg = f"ðŸ—žï¸ {source}\n{title}\n{link if link else guid}"
                  messages.append(msg)
                  new_keys.append(key)

          if not messages:
              print("[INFO] Tidak ada berita baru untuk dikirim")
              exit()

          # Kirim dari yang paling lama
          messages.reverse()
          new_keys.reverse()

          for msg in messages:
              send_url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
              try:
                  resp = requests.post(send_url, data={"chat_id": CHAT_ID, "text": msg})
                  print(f"[POST] Status: {resp.status_code}, text len: {len(msg)}")
              except Exception as e:
                  print(f"[ERROR] Telegram post failed: {e}")

          # Simpan history max 200 key
          history_limit = 200
          all_keys = list(sent_keys) + new_keys
          with open("last.txt","w") as f:
              for k in all_keys[-history_limit:]:
                  f.write(k + "\n")

          print("=== RSS Job Finished UTC:", datetime.utcnow(), "===")
          EOF

      - name: Commit last.txt
        run: |
          git config user.name "rss-bot"
          git config user.email "bot@github.com"
          git add last.txt
          git commit -m "Update last RSS keys" || echo "No new links"
          git push
