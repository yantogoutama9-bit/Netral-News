name: Telegram News Auto Refresh + Translate

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  send:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install dependencies
        run: pip install requests feedparser deep-translator

      - name: Run RSS Script
        env:
          BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          CHAT_ID: "@netralnews_2026"
        run: |
          python3 - << 'EOF'
          import os
          import requests
          import feedparser
          from deep_translator import GoogleTranslator
          from datetime import datetime

          BOT_TOKEN = os.environ["BOT_TOKEN"]
          CHAT_ID = os.environ["CHAT_ID"]

          print("=== JOB START:", datetime.utcnow(), "UTC ===")

          RSS_SOURCES = {
              "REUTERS": "https://feeds.reuters.com/reuters/topNews",
              "BBC": "http://feeds.bbci.co.uk/news/rss.xml",
              "ANTARA": "https://www.antaranews.com/rss/nasional.xml",
              "CNN INDONESIA": "https://www.cnnindonesia.com/rss",
              "SKY SPORTS": "https://www.skysports.com/rss/12040",
              "ESPN SOCCER": "https://www.espn.com/espn/rss/soccer/news"
          }

          FOREIGN_SOURCES = ["REUTERS", "BBC", "SKY SPORTS", "ESPN SOCCER"]

          sent_links = set()
          if os.path.exists("last.txt"):
              with open("last.txt","r") as f:
                  sent_links = set(x.strip() for x in f.readlines() if x.strip())

          new_links = []
          messages = []

          for source, url in RSS_SOURCES.items():
              feed = feedparser.parse(url)

              if not feed.entries:
                  print(f"[INFO] {source} kosong")
                  continue

              for entry in feed.entries[:2]:  # 2 per sumber agar seimbang
                  title = entry.get("title", "")
                  link = entry.get("link", "")

                  if not link or link in sent_links:
                      continue

                  # Translate jika sumber luar
                  if source in FOREIGN_SOURCES:
                      try:
                          title = GoogleTranslator(source='auto', target='id').translate(title)
                      except:
                          pass

                  msg = f"ðŸ—žï¸ {source}\n{title}\n{link}"
                  messages.append(msg)
                  new_links.append(link)

          if not messages:
              print("[INFO] Tidak ada berita baru")
              exit()

          messages.reverse()
          new_links.reverse()

          for msg in messages:
              send_url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
              r = requests.post(send_url, data={
                  "chat_id": CHAT_ID,
                  "text": msg,
                  "disable_web_page_preview": False
              })
              print("[POST]", r.status_code)

          history_limit = 400
          all_links = list(sent_links) + new_links
          with open("last.txt","w") as f:
              for l in all_links[-history_limit:]:
                  f.write(l + "\n")

          print("=== JOB END ===")
          EOF

      - name: Commit last.txt
        run: |
          git config user.name "rss-bot"
          git config user.email "bot@github.com"
          git add last.txt
          git commit -m "Update RSS history" || echo "No changes"
          git push
