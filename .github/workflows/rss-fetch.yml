name: Telegram News Auto Translate Stable

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  send-news:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install dependencies
        run: pip install requests feedparser deep-translator

      - name: Fetch and Send News
        env:
          BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          CHAT_ID: "@netralnews_2026"
        run: |
          python3 - << 'EOF'
          import os
          import requests
          import feedparser
          from deep_translator import GoogleTranslator
          from datetime import datetime

          BOT_TOKEN = os.environ["BOT_TOKEN"]
          CHAT_ID = os.environ["CHAT_ID"]

          print("=== START:", datetime.utcnow(), "UTC ===")

          RSS_SOURCES = {
              "REUTERS": "https://feeds.reuters.com/reuters/topNews",
              "BBC": "https://feeds.bbci.co.uk/news/rss.xml",
              "ANTARA": "https://www.antaranews.com/rss/nasional.xml",
              "CNN INDONESIA": "https://www.cnnindonesia.com/rss",
              "ESPN SOCCER": "https://www.espn.com/espn/rss/soccer/news"
          }

          translator = GoogleTranslator(source='auto', target='id')

          total_sent = 0

          for source, url in RSS_SOURCES.items():
              print("Parsing:", source)
              feed = feedparser.parse(url)

              if not feed.entries:
                  print("-> Tidak ada entries dari", source)
                  continue

              for entry in feed.entries[:2]:
                  title = entry.get("title", "")
                  link = entry.get("link", "")

                  if not link:
                      continue

                  # Auto translate (aman)
                  try:
                      translated = translator.translate(title)
                      if translated:
                          title = translated
                  except Exception as e:
                      print("Translate error:", e)

                  message = f"üóûÔ∏è {source}\n{title}\n{link}"

                  send_url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
                  r = requests.post(send_url, data={
                      "chat_id": CHAT_ID,
                      "text": message,
                      "disable_web_page_preview": False
                  })

                  print("Sent:", r.status_code)
                  total_sent += 1

          print("Total terkirim:", total_sent)
          print("=== END ===")
          EOF
