- name: Run RSS Script
  env:
    BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
    CHAT_ID: "@netralnews_2026"
  run: |
    python3 - << 'EOF'
    import os
    import requests
    import re
    from datetime import datetime

    BOT_TOKEN = os.environ["BOT_TOKEN"]
    CHAT_ID = os.environ["CHAT_ID"]

    RSS_SOURCES = {
        "ANTARA": "https://www.antaranews.com/rss/terkini.xml",
        "KOMPAS": "https://rss.kompas.com/rss",
        "CNN": "https://www.cnnindonesia.com/rss",
        "BBC SPORT": "https://feeds.bbci.co.uk/sport/football/rss.xml",
        "GOAL": "https://www.goal.com/feeds/en/news"
    }

    def get_rss_items(url):
        try:
            r = requests.get(url, timeout=15)
            if r.status_code != 200:
                return []
            content = r.text
            return re.findall(r"<item>(.*?)</item>", content, re.DOTALL)
        except:
            return []

    # Load sent links
    sent_links = set()
    if os.path.exists("last.txt"):
        with open("last.txt", "r") as f:
            sent_links = set(line.strip() for line in f.readlines())

    new_sent = []
    messages = []

    for source, url in RSS_SOURCES.items():
        items = get_rss_items(url)

        for item in items[:5]:  # ambil max 5 per sumber
            title_match = re.search(r"<title>(.*?)</title>", item)
            link_match = re.search(r"<link>(.*?)</link>", item)

            if not title_match or not link_match:
                continue

            title = re.sub('<.*?>', '', title_match.group(1))
            link = link_match.group(1).strip()

            if link in sent_links:
                continue

            msg = f"ðŸ“° {source}\n{title}\n\n{link}"
            messages.append(msg)
            new_sent.append(link)

    if not messages:
        print("Tidak ada berita baru")
        exit()

    # kirim urut
    messages.reverse()

    for msg in messages:
        send_url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
        r = requests.post(send_url, data={
            "chat_id": CHAT_ID,
            "text": msg
        })
        print(r.status_code)

    # simpan semua link baru
    with open("last.txt", "a") as f:
        for link in new_sent:
            f.write(link + "\n")

    EOF
